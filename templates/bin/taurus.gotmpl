//lint:file-ignore ST1001 dot imports are allowed here

package main

import (
	"fmt"
	"log"
	"net/http"
	"time"

	"{{.ProjectName}}/app"
	"{{.ProjectName}}/internal/taurus"

	tmid "{{.ProjectName}}/pkg/middleware"

	"github.com/stones-hub/taurus-pro-http/pkg/middleware"
	"github.com/stones-hub/taurus-pro-http/pkg/router"
)

func main() {
	setGlobalTimezone()
	pprof()
	userRoutes()
	authRoutes()

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/home",
		Handler: http.HandlerFunc(app.Core.IndexController.Home),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path: "/health",
		Handler: http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
			w.WriteHeader(http.StatusOK)
			w.Write([]byte("health"))
		}),
	})

	app.Run()
}

// pprof è·¯ç”±, ç”¨äºæµ‹è¯•å†…å­˜æ³„æ¼
func pprof() {
	// æ·»åŠ å†…å­˜æµ‹è¯•è·¯ç”±
	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/memory/allocate",
		Handler: http.HandlerFunc(app.Core.MemoryController.AllocateMemory),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/memory/leak",
		Handler: http.HandlerFunc(app.Core.MemoryController.SimulateMemoryLeak),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/memory/free",
		Handler: http.HandlerFunc(app.Core.MemoryController.FreeMemory),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})
}



// setGlobalTimezone è®¾ç½®å…¨å±€æ—¶åŒºä¸ºä¸Šæµ·æ—¶åŒº
func setGlobalTimezone() {
	// åŠ è½½ä¸Šæµ·æ—¶åŒº
	shanghaiLoc, err := time.LoadLocation("Asia/Shanghai")
	if err != nil {
		log.Printf("âš ï¸  åŠ è½½ä¸Šæµ·æ—¶åŒºå¤±è´¥: %vï¼Œå°†ä½¿ç”¨ç³»ç»Ÿé»˜è®¤æ—¶åŒº", err)
		return
	}

	// è®¾ç½®å…¨å±€æ—¶åŒº
	time.Local = shanghaiLoc

	log.Printf("âœ… å…¨å±€æ—¶åŒºå·²è®¾ç½®ä¸ºä¸Šæµ·æ—¶åŒº (Asia/Shanghai)")
	log.Printf("ğŸ“… å½“å‰æ—¶é—´: %s", time.Now().Format("2006-01-02 15:04:05 MST"))
}


// userRoutes æ³¨å†Œæ‰€æœ‰User Controllerçš„è·¯ç”±
func userRoutes() {
	// åŸºç¡€CRUDæ“ä½œ
	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/user/create",
		Handler: http.HandlerFunc(app.Core.UserController.CreateUser),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/user/get",
		Handler: http.HandlerFunc(app.Core.UserController.GetUserByID),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/user/getByName",
		Handler: http.HandlerFunc(app.Core.UserController.GetUserByName),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/user/updateName",
		Handler: http.HandlerFunc(app.Core.UserController.UpdateUserName),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/user/updatePassword",
		Handler: http.HandlerFunc(app.Core.UserController.UpdateUserPassword),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/user/delete",
		Handler: http.HandlerFunc(app.Core.UserController.DeleteUser),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	// æŸ¥è¯¢æ“ä½œ
	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/user/all",
		Handler: http.HandlerFunc(app.Core.UserController.GetAllUsers),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/user/page",
		Handler: http.HandlerFunc(app.Core.UserController.GetUsersByPage),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/user/search",
		Handler: http.HandlerFunc(app.Core.UserController.SearchUsers),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/user/count",
		Handler: http.HandlerFunc(app.Core.UserController.GetUserCount),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/user/stats",
		Handler: http.HandlerFunc(app.Core.UserController.GetUserStatistics),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	// é«˜çº§åŠŸèƒ½
	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/user/like",
		Handler: http.HandlerFunc(app.Core.UserController.GetUsersByNameLike),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/user/recent",
		Handler: http.HandlerFunc(app.Core.UserController.GetRecentUsers),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/user/exists",
		Handler: http.HandlerFunc(app.Core.UserController.UserExists),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/user/existsByName",
		Handler: http.HandlerFunc(app.Core.UserController.UserExistsByName),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	// æ‰¹é‡æ“ä½œ
	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/user/createBatch",
		Handler: http.HandlerFunc(app.Core.UserController.CreateUsersBatch),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/user/deleteBatch",
		Handler: http.HandlerFunc(app.Core.UserController.DeleteUsersBatch),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	// SQLæ“ä½œ
	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/user/executeSQL",
		Handler: http.HandlerFunc(app.Core.UserController.ExecuteSQL),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/user/querySQL",
		Handler: http.HandlerFunc(app.Core.UserController.QueryUsersBySQL),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	// ä¸šåŠ¡é€»è¾‘
	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/user/createIfNotExists",
		Handler: http.HandlerFunc(app.Core.UserController.CreateUserIfNotExists),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})
}

// authRoutes æ³¨å†Œæ‰€æœ‰è®¤è¯ç›¸å…³çš„è·¯ç”±
func authRoutes() {
	// åŸºç¡€è®¤è¯è·¯ç”±ï¼ˆä¸éœ€è¦JWTéªŒè¯ï¼‰
	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/auth/login",
		Handler: http.HandlerFunc(app.Core.AuthController.Login),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
			// æ·»åŠ é™æµä¸­é—´ä»¶æµ‹è¯•
			tmid.RateLimitMiddleware(),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/auth/register",
		Handler: http.HandlerFunc(app.Core.AuthController.Register),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
			// æ·»åŠ é™æµä¸­é—´ä»¶æµ‹è¯•
			tmid.RateLimitMiddleware(),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/auth/logout",
		Handler: http.HandlerFunc(app.Core.AuthController.Logout),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/auth/refresh",
		Handler: http.HandlerFunc(app.Core.AuthController.RefreshToken),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	// æµ‹è¯•é™æµä¸­é—´ä»¶çš„è·¯ç”±
	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/auth/test/ratelimit",
		Handler: http.HandlerFunc(app.Core.AuthController.TestRateLimit),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
			// æ·»åŠ é™æµä¸­é—´ä»¶æµ‹è¯•
			tmid.RateLimitMiddleware(),
		},
	})

	// éœ€è¦JWTéªŒè¯çš„è·¯ç”±
	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/auth/profile",
		Handler: http.HandlerFunc(app.Core.AuthController.GetProfile),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
			// æ·»åŠ JWTä¸­é—´ä»¶éªŒè¯
			tmid.JWTMiddleware(),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/auth/profile/update",
		Handler: http.HandlerFunc(app.Core.AuthController.UpdateProfile),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
			// æ·»åŠ JWTä¸­é—´ä»¶éªŒè¯
			tmid.JWTMiddleware(),
		},
	})

	// æµ‹è¯•JWTä¸­é—´ä»¶çš„è·¯ç”±
	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/auth/test/jwt",
		Handler: http.HandlerFunc(app.Core.AuthController.TestJWTMiddleware),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
			// æ·»åŠ JWTä¸­é—´ä»¶éªŒè¯
			tmid.JWTMiddleware(),
		},
	})

	// æµ‹è¯•å®Œæ•´è®¤è¯æµç¨‹çš„è·¯ç”±
	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/auth/test/protected",
		Handler: http.HandlerFunc(app.Core.AuthController.TestProtectedEndpoint),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
			// æ·»åŠ JWTä¸­é—´ä»¶éªŒè¯
			tmid.JWTMiddleware(),
		},
	})
}
