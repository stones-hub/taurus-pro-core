//lint:file-ignore ST1001 dot imports are allowed here

package main

import (
	"fmt"
	"log"
	"net/http"
	"time"

	"{{.ProjectName}}/app"
	"{{.ProjectName}}/internal/taurus"

	"github.com/stones-hub/taurus-pro-http/pkg/middleware"
	"github.com/stones-hub/taurus-pro-http/pkg/router"
)

func main() {
	pprof()

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/home",
		Handler: http.HandlerFunc(app.Core.IndexController.Home),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path: "/health",
		Handler: http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
			w.WriteHeader(http.StatusOK)
			w.Write([]byte("health"))
		}),
	})

	app.Run()
}

// pprof 路由, 用于测试内存泄漏
func pprof() {
	// 添加内存测试路由
	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/memory/allocate",
		Handler: http.HandlerFunc(app.Core.MemoryController.AllocateMemory),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/memory/leak",
		Handler: http.HandlerFunc(app.Core.MemoryController.SimulateMemoryLeak),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/memory/free",
		Handler: http.HandlerFunc(app.Core.MemoryController.FreeMemory),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})
}



// setGlobalTimezone 设置全局时区为上海时区
func setGlobalTimezone() {
	// 加载上海时区
	shanghaiLoc, err := time.LoadLocation("Asia/Shanghai")
	if err != nil {
		log.Printf("⚠️  加载上海时区失败: %v，将使用系统默认时区", err)
		return
	}

	// 设置全局时区
	time.Local = shanghaiLoc

	log.Printf("✅ 全局时区已设置为上海时区 (Asia/Shanghai)")
	log.Printf("📅 当前时间: %s", time.Now().Format("2006-01-02 15:04:05 MST"))
}