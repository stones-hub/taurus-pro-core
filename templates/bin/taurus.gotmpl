//lint:file-ignore ST1001 dot imports are allowed here

package main

import (
	"fmt"
	"log"
	"net/http"
	"strings"
	"time"

	"{{.ProjectName}}/app"
	"{{.ProjectName}}/app/helper/permission"
	"{{.ProjectName}}/internal/taurus"

	tmid "{{.ProjectName}}/pkg/middleware"

	"github.com/stones-hub/taurus-pro-http/pkg/middleware"
	"github.com/stones-hub/taurus-pro-http/pkg/router"
)

func main() {
	setGlobalTimezone()
	// åˆå§‹åŒ–æƒé™æœåŠ¡ä¾èµ–ï¼ˆå¿…é¡»åœ¨æ³¨å†Œè·¯ç”±ä¹‹å‰ï¼Œå› ä¸ºè·¯ç”±å¯èƒ½ä½¿ç”¨æƒé™ä¸­é—´ä»¶ï¼‰
	permissionDependency()
	pprof()
	userRoutes()
	authRoutes()
	staticRoutes()
	adminRoutes()
	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/home",
		Handler: http.HandlerFunc(app.Core.IndexController.Home),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path: "/health",
		Handler: http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
			w.WriteHeader(http.StatusOK)
			w.Write([]byte("health"))
		}),
	})

	app.Run()
}

// pprof è·¯ç”±, ç”¨äºæµ‹è¯•å†…å­˜æ³„æ¼
func pprof() {
	// æ·»åŠ å†…å­˜æµ‹è¯•è·¯ç”±
	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/memory/allocate",
		Handler: http.HandlerFunc(app.Core.MemoryController.AllocateMemory),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/memory/leak",
		Handler: http.HandlerFunc(app.Core.MemoryController.SimulateMemoryLeak),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/memory/free",
		Handler: http.HandlerFunc(app.Core.MemoryController.FreeMemory),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})
}

// setGlobalTimezone è®¾ç½®å…¨å±€æ—¶åŒºä¸ºä¸Šæµ·æ—¶åŒº
func setGlobalTimezone() {
	// åŠ è½½ä¸Šæµ·æ—¶åŒº
	shanghaiLoc, err := time.LoadLocation("Asia/Shanghai")
	if err != nil {
		log.Printf("âš ï¸  åŠ è½½ä¸Šæµ·æ—¶åŒºå¤±è´¥: %vï¼Œå°†ä½¿ç”¨ç³»ç»Ÿé»˜è®¤æ—¶åŒº", err)
		return
	}

	// è®¾ç½®å…¨å±€æ—¶åŒº
	time.Local = shanghaiLoc

	log.Printf("âœ… å…¨å±€æ—¶åŒºå·²è®¾ç½®ä¸ºä¸Šæµ·æ—¶åŒº (Asia/Shanghai)")
	log.Printf("ğŸ“… å½“å‰æ—¶é—´: %s", time.Now().Format("2006-01-02 15:04:05 MST"))
}

// permissionDependency åˆå§‹åŒ–æƒé™æœåŠ¡ä¾èµ–
// åœ¨ main å‡½æ•°ä¸­è°ƒç”¨ï¼Œç¡®ä¿ app.Core å·²ç»åˆ›å»ºï¼ˆåœ¨ app/bootstrap.go çš„ init() ä¸­åˆ›å»ºï¼‰
func permissionDependency() {
	if app.Core != nil && app.Core.AdminRoleService != nil {
		// åˆ›å»ºæƒé™æ£€æŸ¥å™¨ï¼ˆpermission.Checker å®ç°äº† middleware.PermissionChecker æ¥å£ï¼‰
		checker := permission.NewChecker(app.Core.AdminRoleService)
		// æ³¨å…¥åˆ° middleware
		tmid.SetPermissionChecker(checker)
		log.Println("âœ… æƒé™æœåŠ¡ä¾èµ–æ³¨å…¥æˆåŠŸ")
	} else {
		log.Fatal("âŒ Core æˆ– AdminRoleService æœªåˆå§‹åŒ–ï¼Œæƒé™æœåŠ¡ä¾èµ–æ³¨å…¥å¤±è´¥")
	}
}

// userRoutes æ³¨å†Œæ‰€æœ‰User Controllerçš„è·¯ç”±
func userRoutes() {
	// åŸºç¡€CRUDæ“ä½œ
	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/user/create",
		Handler: http.HandlerFunc(app.Core.UserController.CreateUser),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/user/get",
		Handler: http.HandlerFunc(app.Core.UserController.GetUserByID),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/user/getByName",
		Handler: http.HandlerFunc(app.Core.UserController.GetUserByName),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/user/updateName",
		Handler: http.HandlerFunc(app.Core.UserController.UpdateUserName),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/user/updatePassword",
		Handler: http.HandlerFunc(app.Core.UserController.UpdateUserPassword),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/user/delete",
		Handler: http.HandlerFunc(app.Core.UserController.DeleteUser),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	// æŸ¥è¯¢æ“ä½œ
	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/user/all",
		Handler: http.HandlerFunc(app.Core.UserController.GetAllUsers),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/user/page",
		Handler: http.HandlerFunc(app.Core.UserController.GetUsersByPage),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/user/search",
		Handler: http.HandlerFunc(app.Core.UserController.SearchUsers),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/user/count",
		Handler: http.HandlerFunc(app.Core.UserController.GetUserCount),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/user/stats",
		Handler: http.HandlerFunc(app.Core.UserController.GetUserStatistics),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	// é«˜çº§åŠŸèƒ½
	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/user/like",
		Handler: http.HandlerFunc(app.Core.UserController.GetUsersByNameLike),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/user/recent",
		Handler: http.HandlerFunc(app.Core.UserController.GetRecentUsers),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/user/exists",
		Handler: http.HandlerFunc(app.Core.UserController.UserExists),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/user/existsByName",
		Handler: http.HandlerFunc(app.Core.UserController.UserExistsByName),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	// æ‰¹é‡æ“ä½œ
	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/user/createBatch",
		Handler: http.HandlerFunc(app.Core.UserController.CreateUsersBatch),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/user/deleteBatch",
		Handler: http.HandlerFunc(app.Core.UserController.DeleteUsersBatch),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	// SQLæ“ä½œ
	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/user/executeSQL",
		Handler: http.HandlerFunc(app.Core.UserController.ExecuteSQL),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/user/querySQL",
		Handler: http.HandlerFunc(app.Core.UserController.QueryUsersBySQL),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	// ä¸šåŠ¡é€»è¾‘
	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/user/createIfNotExists",
		Handler: http.HandlerFunc(app.Core.UserController.CreateUserIfNotExists),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})
}

// authRoutes æ³¨å†Œæ‰€æœ‰è®¤è¯ç›¸å…³çš„è·¯ç”±
func authRoutes() {
	// åŸºç¡€è®¤è¯è·¯ç”±ï¼ˆä¸éœ€è¦JWTéªŒè¯ï¼‰
	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/auth/login",
		Handler: http.HandlerFunc(app.Core.AuthController.Login),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
			// æ·»åŠ é™æµä¸­é—´ä»¶æµ‹è¯•
			tmid.RateLimitMiddleware(),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/auth/register",
		Handler: http.HandlerFunc(app.Core.AuthController.Register),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
			// æ·»åŠ é™æµä¸­é—´ä»¶æµ‹è¯•
			tmid.RateLimitMiddleware(),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/auth/logout",
		Handler: http.HandlerFunc(app.Core.AuthController.Logout),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/auth/refresh",
		Handler: http.HandlerFunc(app.Core.AuthController.RefreshToken),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	// æµ‹è¯•é™æµä¸­é—´ä»¶çš„è·¯ç”±
	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/auth/test/ratelimit",
		Handler: http.HandlerFunc(app.Core.AuthController.TestRateLimit),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
			// æ·»åŠ é™æµä¸­é—´ä»¶æµ‹è¯•
			tmid.RateLimitMiddleware(),
		},
	})

	// éœ€è¦JWTéªŒè¯çš„è·¯ç”±
	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/auth/profile",
		Handler: http.HandlerFunc(app.Core.AuthController.GetProfile),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
			// æ·»åŠ JWTä¸­é—´ä»¶éªŒè¯
			tmid.JWTMiddleware(),
		},
	})

	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/auth/profile/update",
		Handler: http.HandlerFunc(app.Core.AuthController.UpdateProfile),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
			// æ·»åŠ JWTä¸­é—´ä»¶éªŒè¯
			tmid.JWTMiddleware(),
		},
	})

	// æµ‹è¯•JWTä¸­é—´ä»¶çš„è·¯ç”±
	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/auth/test/jwt",
		Handler: http.HandlerFunc(app.Core.AuthController.TestJWTMiddleware),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
			// æ·»åŠ JWTä¸­é—´ä»¶éªŒè¯
			tmid.JWTMiddleware(),
		},
	})

	// æµ‹è¯•å®Œæ•´è®¤è¯æµç¨‹çš„è·¯ç”±
	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/auth/test/protected",
		Handler: http.HandlerFunc(app.Core.AuthController.TestProtectedEndpoint),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
			// æ·»åŠ JWTä¸­é—´ä»¶éªŒè¯
			tmid.JWTMiddleware(),
		},
	})
}

func staticRoutes() {
	// é™æ€æ–‡ä»¶è·¯ç”± - CSS, JS, å›¾ç‰‡ç­‰
	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/static/",
		Handler: http.StripPrefix("/static/", http.FileServer(http.Dir("static/"))),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	// æ·»åŠ ä¸‹è½½æ–‡ä»¶è·¯ç”±
	taurus.Container.Http.AddRouter(router.Router{
		Path:    "/downloads/",
		Handler: http.StripPrefix("/downloads/", http.FileServer(http.Dir("downloads/"))),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

	// æ·»åŠ ç®¡ç†å‘˜æ¨¡æ¿è·¯ç”± - ç»Ÿä¸€å¤„ç† /admin/ å’Œ /admin/tpl/
	taurus.Container.Http.AddRouter(router.Router{
		Path: "/admin/",
		Handler: http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
			fmt.Println("r.URL.Path", r.URL.Path)
			// å¤„ç†æ ¹è·¯å¾„ï¼š/admin æˆ– /admin/ æˆ– /admin/tpl æˆ– /admin/tpl/
			if r.URL.Path == "/admin" || r.URL.Path == "/admin/" ||
				r.URL.Path == "/admin/tpl" || r.URL.Path == "/admin/tpl/" {
				http.ServeFile(w, r, "templates/admin/login.html")
				return
			}

			// å¤„ç† /admin/tpl/* çš„æ¨¡æ¿æ–‡ä»¶ - å¿…é¡»æ˜¯ä»¥ /admin/tpl/ å¼€å¤´çš„è·¯å¾„
			if strings.HasPrefix(r.URL.Path, "/admin/tpl/") && len(r.URL.Path) > len("/admin/tpl/") {
				http.StripPrefix("/admin/tpl/", http.FileServer(http.Dir("templates/admin/"))).ServeHTTP(w, r)
				return
			}

			// å…¶ä»–æƒ…å†µè¿”å› 404
			w.WriteHeader(http.StatusNotFound)
			w.Write([]byte("404 Not Found"))
		}),
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
	})

}

func adminRoutes() {
	// ç”¨æˆ·ç®¡ç†è·¯ç”± - ä¸éœ€è¦JWTéªŒè¯çš„æ¥å£
	taurus.Container.Http.AddRouterGroup(router.RouteGroup{
		Prefix: "/admin/user",
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
		},
		Routes: []router.Router{
			// ç”¨æˆ·ç™»å½•æ¥å£
			{
				Path:    "/login",
				Handler: http.HandlerFunc(app.Core.UserApiController.Login),
			},
			// å‘é€éªŒè¯ç æ¥å£
			{
				Path:    "/send-code",
				Handler: http.HandlerFunc(app.Core.UserApiController.SendCode),
			},
			// OAuthåˆå§‹åŒ–æ¥å£ï¼ˆç”Ÿæˆstate/nonceï¼‰
			{
				Path:    "/oauth-init",
				Handler: http.HandlerFunc(app.Core.UserApiController.OAuthInit),
			},
		},
	})

	// ç”¨æˆ·ç®¡ç†è·¯ç”± - éœ€è¦JWTéªŒè¯çš„æ¥å£ï¼ˆåŸºç¡€åŠŸèƒ½ï¼Œä¸éœ€è¦æƒé™æ ¡éªŒï¼‰
	taurus.Container.Http.AddRouterGroup(router.RouteGroup{
		Prefix: "/admin/user",
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
			// æ·»åŠ JWTä¸­é—´ä»¶éªŒè¯
			tmid.JWTMiddleware(),
			tmid.PasswordChangeValidatorMiddleware(),
			// æ·»åŠ CSRFä¸­é—´ä»¶éªŒè¯ï¼ˆåœ¨JWTä¹‹åï¼Œä»…å¯¹POST/PUT/DELETEç­‰ä¿®æ”¹æ•°æ®çš„è¯·æ±‚ç”Ÿæ•ˆï¼‰
			tmid.CSRFMiddleware(),
		},
		Routes: []router.Router{
			// ç”¨æˆ·ç™»å‡ºæ¥å£
			{
				Path:    "/logout",
				Handler: http.HandlerFunc(app.Core.UserApiController.Logout),
			},
			// è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
			{
				Path:    "/current-info",
				Handler: http.HandlerFunc(app.Core.UserApiController.GetCurrentUserInfo),
			},
			// æ›´æ–°å½“å‰ç”¨æˆ·ä¸ªäººä¿¡æ¯ï¼ˆè‡ªå·±æ”¹è‡ªå·±çš„ä¿¡æ¯ï¼Œä¸éœ€è¦æƒé™æ ¡éªŒï¼‰
			{
				Path:    "/update-profile",
				Handler: http.HandlerFunc(app.Core.UserApiController.UpdateCurrentUserProfile),
			},
			// è·å–ç”¨æˆ·èœå•å’ŒæŒ‰é’®æƒé™
			{
				Path:    "/menus-buttons",
				Handler: http.HandlerFunc(app.Core.UserApiController.GetUserMenusAndButtons),
			},
		},
	})

	// ç”¨æˆ·ç®¡ç†è·¯ç”± - éœ€è¦JWTéªŒè¯å’Œæƒé™æ ¡éªŒçš„æ¥å£ï¼ˆç®¡ç†åŠŸèƒ½ï¼‰
	taurus.Container.Http.AddRouterGroup(router.RouteGroup{
		Prefix: "/admin/user",
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
			// æ·»åŠ JWTä¸­é—´ä»¶éªŒè¯
			tmid.JWTMiddleware(),
			tmid.PasswordChangeValidatorMiddleware(),
			// æ·»åŠ æƒé™æ ¡éªŒä¸­é—´ä»¶ï¼ˆåœ¨JWTä¹‹åï¼ŒCSRFä¹‹å‰ï¼‰
			tmid.PermissionMiddleware(),
			// æ·»åŠ CSRFä¸­é—´ä»¶éªŒè¯ï¼ˆåœ¨JWTä¹‹åï¼Œä»…å¯¹POST/PUT/DELETEç­‰ä¿®æ”¹æ•°æ®çš„è¯·æ±‚ç”Ÿæ•ˆï¼‰
			tmid.CSRFMiddleware(),
		},
		Routes: []router.Router{
			// è·å–ç”¨æˆ·åˆ—è¡¨
			{
				Path:    "/list",
				Handler: http.HandlerFunc(app.Core.UserApiController.GetUserList),
			},
			// æ›´æ–°ç”¨æˆ·çŠ¶æ€
			{
				Path:    "/update-status",
				Handler: http.HandlerFunc(app.Core.UserApiController.UpdateUserStatus),
			},
			// è·å–ç”¨æˆ·ä¿¡æ¯
			{
				Path:    "/info",
				Handler: http.HandlerFunc(app.Core.UserApiController.GetUserInfo),
			},
			// è®¾ç½®/é‡ç½®å¯†ç 
			{
				Path:    "/set-password",
				Handler: http.HandlerFunc(app.Core.UserApiController.SetPassword),
			},
			// åˆ é™¤ç”¨æˆ·
			{
				Path:    "/delete",
				Handler: http.HandlerFunc(app.Core.UserApiController.DeleteUser),
			},
			// æ›´æ–°ç”¨æˆ·
			{
				Path:    "/update",
				Handler: http.HandlerFunc(app.Core.UserApiController.UpdateUser),
			},
			// æ–°å¢ç”¨æˆ·
			{
				Path:    "/add",
				Handler: http.HandlerFunc(app.Core.UserApiController.AddUser),
			},

			// ä¿®æ”¹å¯†ç ï¼ˆè‡ªå·±æ”¹è‡ªå·±çš„å¯†ç ï¼Œä¸éœ€è¦æƒé™æ ¡éªŒï¼‰
			{
				Path:    "/change-password",
				Handler: http.HandlerFunc(app.Core.UserApiController.ChangePassword),
			},
			// ç»‘å®šæ‰‹æœºå·ï¼ˆè‡ªå·±ç»‘å®šï¼Œä¸éœ€è¦æƒé™æ ¡éªŒï¼‰
			{
				Path:    "/bind-mobile",
				Handler: http.HandlerFunc(app.Core.UserApiController.BindMobile),
			},
			// è§£ç»‘æ‰‹æœºå·ï¼ˆè‡ªå·±è§£ç»‘ï¼Œä¸éœ€è¦æƒé™æ ¡éªŒï¼‰
			{
				Path:    "/unbind-mobile",
				Handler: http.HandlerFunc(app.Core.UserApiController.UnbindMobile),
			},
		},
	})

	// è§’è‰²ç®¡ç†è·¯ç”± - éœ€è¦JWTéªŒè¯å’Œæƒé™æ ¡éªŒçš„æ¥å£
	taurus.Container.Http.AddRouterGroup(router.RouteGroup{
		Prefix: "/admin/role",
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
			tmid.JWTMiddleware(),
			tmid.PasswordChangeValidatorMiddleware(),
			// æ·»åŠ æƒé™æ ¡éªŒä¸­é—´ä»¶ï¼ˆåœ¨JWTä¹‹åï¼ŒCSRFä¹‹å‰ï¼‰
			tmid.PermissionMiddleware(),
			tmid.CSRFMiddleware(),
		},
		Routes: []router.Router{
			// è·å–ç”¨æˆ·è§’è‰²å’Œæƒé™
			{
				Path:    "/get-user-role-permissions",
				Handler: http.HandlerFunc(app.Core.RoleController.GetUserRolesAndPermissions),
			},
			// è·å–è§’è‰²åˆ—è¡¨
			{
				Path:    "/list",
				Handler: http.HandlerFunc(app.Core.RoleController.GetRoleList),
			},
			// è·å–è§’è‰²è¯¦æƒ…
			{
				Path:    "/detail",
				Handler: http.HandlerFunc(app.Core.RoleController.GetRoleDetail),
			},
			// æ›´æ–°è§’è‰²çŠ¶æ€
			{
				Path:    "/update-status",
				Handler: http.HandlerFunc(app.Core.RoleController.UpdateRoleStatus),
			},
			// åˆ é™¤è§’è‰²
			{
				Path:    "/delete",
				Handler: http.HandlerFunc(app.Core.RoleController.DeleteRole),
			},
			// ç¼–è¾‘è§’è‰²ä¿¡æ¯
			{
				Path:    "/edit-info",
				Handler: http.HandlerFunc(app.Core.RoleController.GetEditRoleInfo),
			},
			// æ›´æ–°è§’è‰²
			{
				Path:    "/update",
				Handler: http.HandlerFunc(app.Core.RoleController.UpdateRole),
			},
			// æ›´æ–°æ˜¯å¦ç³»ç»Ÿè§’è‰²
			{
				Path:    "/update-is-system",
				Handler: http.HandlerFunc(app.Core.RoleController.UpdateRoleIsSystem),
			},
			// æ–°å¢è§’è‰²
			{
				Path:    "/add",
				Handler: http.HandlerFunc(app.Core.RoleController.AddRole),
			},
			// è·å–æ‰€æœ‰æƒé™ï¼ˆç”¨äºæ–°å¢è§’è‰²ï¼‰
			{
				Path:    "/get-all-permissions",
				Handler: http.HandlerFunc(app.Core.RoleController.GetAllPermissions),
			},
		},
	})

	// æƒé™ç®¡ç†è·¯ç”± - éœ€è¦JWTéªŒè¯å’Œæƒé™æ ¡éªŒçš„æ¥å£
	taurus.Container.Http.AddRouterGroup(router.RouteGroup{
		Prefix: "/admin/permission",
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
			tmid.JWTMiddleware(),
			tmid.PasswordChangeValidatorMiddleware(),
			// æ·»åŠ æƒé™æ ¡éªŒä¸­é—´ä»¶ï¼ˆåœ¨JWTä¹‹åï¼ŒCSRFä¹‹å‰ï¼‰
			tmid.PermissionMiddleware(),
			tmid.CSRFMiddleware(),
		},
		Routes: []router.Router{
			// è·å–æƒé™åˆ—è¡¨
			{
				Path:    "/list",
				Handler: http.HandlerFunc(app.Core.PermissionController.GetPermissionList),
			},
			// æ–°å¢æƒé™
			{
				Path:    "/add",
				Handler: http.HandlerFunc(app.Core.PermissionController.AddPermission),
			},
			// æ›´æ–°æƒé™
			{
				Path:    "/update",
				Handler: http.HandlerFunc(app.Core.PermissionController.UpdatePermission),
			},
			// åˆ é™¤æƒé™
			{
				Path:    "/delete",
				Handler: http.HandlerFunc(app.Core.PermissionController.DeletePermission),
			},
			// æ›´æ–°æƒé™çŠ¶æ€
			{
				Path:    "/update-status",
				Handler: http.HandlerFunc(app.Core.PermissionController.UpdatePermissionStatus),
			},
			{
				Path:    "/update-is-system",
				Handler: http.HandlerFunc(app.Core.PermissionController.UpdatePermissionIsSystem),
			},
			// è·å–ç¼–è¾‘æƒé™ä¿¡æ¯
			{
				Path:    "/edit-info",
				Handler: http.HandlerFunc(app.Core.PermissionController.GetEditPermissionInfo),
			},
			// è·å–æƒé™æ ‘
			{
				Path:    "/get-tree",
				Handler: http.HandlerFunc(app.Core.PermissionController.GetPermissionTree),
			},
		},
	})

	// ç™»å½•æ—¥å¿—ç®¡ç†è·¯ç”± - éœ€è¦JWTéªŒè¯å’Œæƒé™æ ¡éªŒçš„æ¥å£
	taurus.Container.Http.AddRouterGroup(router.RouteGroup{
		Prefix: "/admin/login-log",
		Middleware: []router.MiddlewareFunc{
			middleware.RecoveryMiddleware(func(err any, stack string) {
				fmt.Printf("Error: %v\nStack: %s\n", err, stack)
			}),
			tmid.JWTMiddleware(),
			tmid.PasswordChangeValidatorMiddleware(),
			// æ·»åŠ æƒé™æ ¡éªŒä¸­é—´ä»¶ï¼ˆåœ¨JWTä¹‹åï¼ŒCSRFä¹‹å‰ï¼‰
			tmid.PermissionMiddleware(),
			tmid.CSRFMiddleware(),
		},
		Routes: []router.Router{
			// è·å–ç™»å½•æ—¥å¿—åˆ—è¡¨
			{
				Path:    "/list",
				Handler: http.HandlerFunc(app.Core.LogApiController.LoginLogList),
			},
		},
	})
}
