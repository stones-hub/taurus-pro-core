<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="keywords" content="" />
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=9;IE=10;IE=Edge,chrome=1" />
    <link rel="stylesheet" href="/static/lib/theme-chalk/nui.min.css" />
    <link rel="stylesheet" href="/static/css/common.css" />
    <script type="text/javascript" src="/static/lib/nui.min.js"></script>
    <script type="text/javascript" src="/static/js/js.cookie.js"></script>
    <script type="text/javascript" src="/static/js/config.js"></script>
    <script type="text/javascript" src="/static/js/app.js"></script>
    <script
      type="text/javascript"
      src="/static/js/lib/jquery@3.3.1/jquery.min.js"
    ></script>
    <script type="text/javascript" src="/static/js/tools.js"></script>
  </head>

  <body>
    <div id="app" type="page" class="base-container">
      <div class="my-title">设置密码</div>

      <!-- 说明信息 -->
      <div class="my-form ui-grid" style="margin-bottom: 20px;">
        <div class="form-group ui-grid-cell col-24">
          <div style="padding: 15px; background-color: #f0f9ff; border-left: 4px solid #1890ff; border-radius: 4px;">
            <p style="margin: 0; color: #1890ff; font-size: 14px;">
              <strong>提示：</strong>此页面用于设置或重置密码。设置成功后，您可以使用用户名和密码登录系统。
            </p>
          </div>
        </div>
      </div>

      <!-- 密码设置表单 -->
      <div class="form-section-divider">
        <span class="divider-text">密码设置</span>
      </div>
      
      <!-- 新密码 -->
      <div class="my-form ui-grid">
        <div class="form-group ui-grid-cell col-8">
          <label class="control-label" required>新密码：</label>
          <ui-textbox
            class="form-control"
            type="password"
            placeholder="请输入新密码（6-20位，包含字母和数字）"
            v-model="passwordForm.new_password"
            :autofocus="true"
          ></ui-textbox>
        </div>
      </div>
      
      <!-- 确认新密码 -->
      <div class="my-form ui-grid">
        <div class="form-group ui-grid-cell col-8">
          <label class="control-label" required>确认新密码：</label>
          <ui-textbox
            class="form-control"
            type="password"
            placeholder="请再次输入新密码"
            v-model="passwordForm.confirm_password"
          ></ui-textbox>
        </div>
      </div>
      
      <!-- 操作按钮 -->
      <div class="form-group ui-grid-cell col-24" style="text-align: right; margin-top: 20px;">
        <div class="btn-group">
          <ui-button
            @click="onCancel"
            style="margin-right: 10px;"
          >取消</ui-button>
          <ui-button
            color="primary"
            @click="onSetPassword"
            :disabled="submitBtn.disabled"
          >{{submitBtn.text}}</ui-button>
        </div>
      </div>
    </div>

    <script>
      NUI({
        data: {
          passwordForm: {
            new_password: '',
            confirm_password: ''
          },
          submitBtn: {
            disabled: false,
            text: '设置密码'
          }
        },
        created() {
          // 页面创建时检查是否已登录
          this.checkAuth();
        },
        methods: {
          // 检查认证状态
          checkAuth() {
            // 这里可以添加JWT token检查逻辑
            // 如果未登录，可以重定向到登录页
          },
          
          // 设置密码
          onSetPassword() {
            // 表单校验 - 新密码
            if (!this.passwordForm.new_password || this.passwordForm.new_password.trim() === '') {
              tools.showMsg('请输入新密码', 0);
              return;
            }

            // 表单校验 - 新密码格式
            var newPasswordResult = app.validatePassword(this.passwordForm.new_password);
            if (!newPasswordResult.valid) {
              tools.showMsg(newPasswordResult.message, 0);
              return;
            }

            // 表单校验 - 确认密码
            if (this.passwordForm.new_password !== this.passwordForm.confirm_password) {
              tools.showMsg('两次输入的新密码不一致', 0);
              return;
            }

            // 设置按钮状态
            this.submitBtn.disabled = true;
            this.submitBtn.text = '设置中...';

            app.postJson({
              url: API_CONFIG.buildURL(API_CONFIG.ADMIN.USER.SET_PASSWORD),
              data: {
                password: this.passwordForm.new_password
              },
              success: (res) => {
                if (res && res.code == 0) {
                  tools.showMsg('密码设置成功', 1);
                  // 清空表单
                  this.passwordForm = {
                    new_password: '',
                    confirm_password: ''
                  };
                  // 如果返回了新token，更新token
                  if (res.data && res.data.token) {
                    // token会自动通过Set-Cookie设置，前端无需处理
                  }
                  // 延迟跳转到个人资料页面
                  setTimeout(() => {
                    if (API_CONFIG.ADMIN.USER.PROFILE) {
                      tools.jump(API_CONFIG.ADMIN.USER.PROFILE);
                    } else {
                      // 如果没有配置，使用默认路径
                      tools.jump('/admin/tpl/page/profile/profile.html');
                    }
                  }, 1500);
                } else {
                  tools.showMsg(res.message || '密码设置失败', 0);
                }
                this.submitBtn.disabled = false;
                this.submitBtn.text = '设置密码';
              },
              error: (err) => {
                tools.showMsg(err.message || '密码设置失败', 0);
                this.submitBtn.disabled = false;
                this.submitBtn.text = '设置密码';
              }
            });
          },
          
          // 取消操作
          onCancel() {
            // 返回个人资料页面
            if (API_CONFIG.ADMIN.USER.PROFILE) {
              tools.jump(API_CONFIG.ADMIN.USER.PROFILE);
            } else {
              // 如果没有配置，使用默认路径
              tools.jump('/admin/tpl/page/profile/profile.html');
            }
          }
        }
      });
    </script>
  </body>
</html>
