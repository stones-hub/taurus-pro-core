flowchart TD
  A[开始] --> B[输入手机号+验证码]
  B --> C[归一化手机号]
  C --> D{验证码校验(一次性/TTL/限频)}
  D -->|失败| F1[失败: 验证码错误/过期/限流]
  D -->|通过| T[开启事务]
  T --> E{查用户: mobile & user_login(type=sms)}
  E -->|老用户| S{状态校验}
  S -->|非法| F2[失败: 状态非法]
  S -->|合法| CMT[提交事务] --> Z[登录成功]
  E -->|新用户| N[创建 admin_user + user_login(sms)]
  N -->|唯一键冲突| R[重查归因/可重试或失败] --> F3[失败: 系统忙]
  N -->|创建成功| CMT2[提交事务] --> Z
  E --> F[发现 admin_user 存在但缺少 sms 登录?]
  F -->|是| FIX[同事务补齐 sms 登录并审计] --> S
  F -->|否| S


