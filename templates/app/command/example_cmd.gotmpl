package command

import (
	"fmt"
	"log"
	"strings"
	"time"

	"github.com/stones-hub/taurus-pro-common/pkg/cmd"
)

// ç»§æ‰¿cmd.BaseCommandå’Œcmd.Commandæ¥å£
type ExampleCommand struct {
	cmd.BaseCommand
}

// Run æ‰§è¡Œç”¨æˆ·ç®¡ç†å‘½ä»¤
func (c *ExampleCommand) Run(args []string) error {
	ctx, err := c.ParseOptions(args)
	if err != nil {
		return err
	}

	// è·å–æ‰€æœ‰é€‰é¡¹å€¼
	name := ctx.Options["name"].(string)
	email := ctx.Options["email"].(string)
	age := ctx.Options["age"].(int)
	active := ctx.Options["active"].(bool)
	score := ctx.Options["score"].(float64)
	verbose := ctx.Options["verbose"].(bool)
	roles := ctx.Options["roles"].(string)
	department := ctx.Options["department"].(string)
	level := ctx.Options["level"].(int)
	verified := ctx.Options["verified"].(bool)
	salary := ctx.Options["salary"].(float64)

	fmt.Println("=== ç”¨æˆ·ç®¡ç†å‘½ä»¤ ===")
	fmt.Printf("æ‰§è¡Œæ—¶é—´: %s\n", time.Now().Format("2006-01-02 15:04:05"))
	fmt.Println()

	// åŸºæœ¬ä¿¡æ¯
	fmt.Println("ğŸ“‹ ç”¨æˆ·åŸºæœ¬ä¿¡æ¯:")
	fmt.Printf("  å§“å: %s\n", name)
	fmt.Printf("  é‚®ç®±: %s\n", email)
	fmt.Printf("  å¹´é¾„: %d\n", age)
	fmt.Printf("  éƒ¨é—¨: %s\n", department)
	fmt.Printf("  çº§åˆ«: %d\n", level)
	fmt.Printf("  è§’è‰²: %s\n", roles)
	fmt.Printf("  çŠ¶æ€: %s\n", map[bool]string{true: "æ¿€æ´»", false: "ç¦ç”¨"}[active])
	fmt.Printf("  éªŒè¯: %s\n", map[bool]string{true: "å·²éªŒè¯", false: "æœªéªŒè¯"}[verified])
	fmt.Printf("  è¯„åˆ†: %.1f\n", score)
	fmt.Printf("  è–ªèµ„: Â¥%.2f\n", salary)

	// è¯¦ç»†åˆ†æ
	if verbose {
		fmt.Println()
		fmt.Println("ğŸ” è¯¦ç»†åˆ†æ:")
		fmt.Printf("  å§“åé•¿åº¦: %d å­—ç¬¦\n", len(name))
		fmt.Printf("  å¹´é¾„åˆ†ç±»: %s\n", getAgeCategory(age))
		fmt.Printf("  è¯„åˆ†ç­‰çº§: %s\n", getScoreGrade(score))
		fmt.Printf("  è–ªèµ„ç­‰çº§: %s\n", getSalaryLevel(salary))
		fmt.Printf("  é‚®ç®±åŸŸå: %s\n", getEmailDomain(email))
		fmt.Printf("  è§’è‰²æ•°é‡: %d\n", len(strings.Split(roles, ",")))
	}

	// ä¸šåŠ¡é€»è¾‘
	fmt.Println()
	fmt.Println("âš™ï¸  ä¸šåŠ¡å¤„ç†:")
	fmt.Printf("  æ­£åœ¨åˆ›å»ºç”¨æˆ·: %s\n", name)
	time.Sleep(100 * time.Millisecond)

	if !verified {
		fmt.Printf("  å‘é€éªŒè¯é‚®ä»¶åˆ°: %s\n", email)
		time.Sleep(50 * time.Millisecond)
	}

	if active {
		fmt.Printf("  æ¿€æ´»ç”¨æˆ·è´¦æˆ·\n")
		time.Sleep(50 * time.Millisecond)
	}

	fmt.Printf("  åˆ†é…è§’è‰²: %s\n", roles)
	time.Sleep(50 * time.Millisecond)

	fmt.Printf("  è®¾ç½®éƒ¨é—¨: %s\n", department)
	time.Sleep(50 * time.Millisecond)

	fmt.Println()
	fmt.Println("âœ… ç”¨æˆ·åˆ›å»ºå®Œæˆ!")

	return nil
}

// ==================== è¾…åŠ©å‡½æ•° ====================

func getAgeCategory(age int) string {
	switch {
	case age < 18:
		return "æœªæˆå¹´"
	case age < 30:
		return "é’å¹´"
	case age < 50:
		return "ä¸­å¹´"
	case age < 65:
		return "ä¸­è€å¹´"
	default:
		return "è€å¹´"
	}
}

func getScoreGrade(score float64) string {
	switch {
	case score >= 90:
		return "ä¼˜ç§€"
	case score >= 80:
		return "è‰¯å¥½"
	case score >= 70:
		return "ä¸­ç­‰"
	case score >= 60:
		return "åŠæ ¼"
	default:
		return "ä¸åŠæ ¼"
	}
}

func getSalaryLevel(salary float64) string {
	switch {
	case salary >= 50000:
		return "é«˜è–ª"
	case salary >= 20000:
		return "ä¸­è–ª"
	case salary >= 8000:
		return "æ ‡å‡†"
	default:
		return "åŸºç¡€"
	}
}

func getEmailDomain(email string) string {
	parts := strings.Split(email, "@")
	if len(parts) == 2 {
		return parts[1]
	}
	return "æœªçŸ¥"
}

func init() {
	// æ³¨å†Œç®¡ç†å‘½ä»¤
	baseCommand, err := cmd.NewBaseCommand(
		"user",
		"ç”¨æˆ·ç®¡ç†å‘½ä»¤ - åˆ›å»ºã€æŸ¥è¯¢ã€æ›´æ–°ç”¨æˆ·ä¿¡æ¯ï¼Œæ”¯æŒæ‰€æœ‰æ•°æ®ç±»å‹",
		"[options]",
		[]cmd.Option{
			{
				Name:        "name",
				Shorthand:   "n",
				Description: "ç”¨æˆ·åï¼ˆå¿…å¡«ï¼‰",
				Type:        cmd.OptionTypeString,
				Required:    true,
			},
			{
				Name:        "email",
				Shorthand:   "e",
				Description: "é‚®ç®±åœ°å€",
				Type:        cmd.OptionTypeString,
				Default:     "user@example.com",
			},
			{
				Name:        "age",
				Shorthand:   "a",
				Description: "å¹´é¾„",
				Type:        cmd.OptionTypeInt,
				Default:     25,
			},
			{
				Name:        "active",
				Shorthand:   "A",
				Description: "æ˜¯å¦æ¿€æ´»",
				Type:        cmd.OptionTypeBool,
				Default:     true,
			},
			{
				Name:        "score",
				Shorthand:   "s",
				Description: "ç”¨æˆ·è¯„åˆ†",
				Type:        cmd.OptionTypeFloat,
				Default:     85.5,
			},
			{
				Name:        "verbose",
				Shorthand:   "v",
				Description: "è¯¦ç»†è¾“å‡º",
				Type:        cmd.OptionTypeBool,
				Default:     false,
			},
			{
				Name:        "roles",
				Shorthand:   "r",
				Description: "ç”¨æˆ·è§’è‰²ï¼ˆé€—å·åˆ†éš”ï¼‰",
				Type:        cmd.OptionTypeString,
				Default:     "user",
			},
			{
				Name:        "department",
				Shorthand:   "d",
				Description: "æ‰€å±éƒ¨é—¨",
				Type:        cmd.OptionTypeString,
				Default:     "æŠ€æœ¯éƒ¨",
			},
			{
				Name:        "level",
				Shorthand:   "l",
				Description: "ç”¨æˆ·çº§åˆ«",
				Type:        cmd.OptionTypeInt,
				Default:     1,
			},
			{
				Name:        "verified",
				Shorthand:   "V",
				Description: "æ˜¯å¦å·²éªŒè¯",
				Type:        cmd.OptionTypeBool,
				Default:     false,
			},
			{
				Name:        "salary",
				Shorthand:   "S",
				Description: "è–ªèµ„",
				Type:        cmd.OptionTypeFloat,
				Default:     15000.0,
			},
		},
	)
	if err != nil {
		log.Printf("NewBaseCommand failed: %v\n", err)
		return
	}
	Register(&ExampleCommand{
		BaseCommand: *baseCommand,
	})
}
